# T02.5.1: Tag Schema – Relationship Mapping
**Owner:** DATA-024 (Ontology and Taxonomy Designer)  
**Date:** 2026-01-14  
**Status:** ✅ COMPLETE  
**Evidence Artifact:** Cross-Dimension Relationship Mapping

---

## Classification → Tag Domain/Category Bridge

**Purpose:** Enable direct handoff from T02.4.1 classification system to T02.5.1 tag assignment.

### Mapping Table

| Classification Output (T02.4.1) | Confidence | → Tag Domain | → Tag Category | Rationale | Manual Review? |
|---|---|---|---|---|---|
| **Invoice** | 94-96% | DOM-002 (Finance) | CAT-008 (Metrics) | Billable events; tracked for revenue; KPI tracking | If conf < 90% |
| **Receipt** | 92-94% | DOM-002 (Finance) | CAT-003 (Workflow) | Evidence of payment; part of payment approval workflow | If conf < 85% |
| **Contract** | 96-97% | DOM-001 (Finance/Legal) | CAT-005 (Governance) | Binding agreement; governance artifact; audit trail | If conf < 95% |
| **Report** | 88-91% | DOM-004 (Ops/Product) | CAT-008 (Metrics) | Performance data; KPI source; trend analysis | If conf < 85% |
| **Specification** | 89-92% | DOM-007 (Product) | CAT-007 (Data/Schema) | Technical design; system constraints; architecture | If conf < 85% |
| **Other** | <70% | (untagged) | (untagged) | Ambiguous; defer to human classification | ALWAYS |

**Notes:**
- Confidence thresholds ensure only high-confidence classifications auto-assign tags
- Manual review row triggered when T02.4.3 confidence ≤ threshold
- "Other" category → human triager reviews + assigns domain/category explicitly

### Document Flow: Classification → Tagging

```
Workflow:
1. Import (D02.1)
   └─ Document stored with document_id, import_date, dedup_hash
   
2. Classification (D02.4)
   └─ LLM + prompts determine type (Invoice/Receipt/Contract/Report/Spec/Other)
   └─ Confidence score attached (88-97% range)
   
3. Tag Assignment (T02.5.2 Auto)
   ├─ If classification type is mapped AND confidence > threshold:
   │  └─ Create document_tags row with domain_id + category_id
   │  └─ Set status = STA-001 (NEW)
   │  └─ Set priority = PRI-004 (Low, default)
   │
   └─ If classification type is "Other" OR confidence ≤ threshold:
      └─ Flag for human review
      └─ Notify domain lead (email/dashboard)
      └─ Await manual tag assignment

4. Review (Domain Lead)
   ├─ Review auto-assigned tags (for errors/edge cases)
   ├─ Manually assign tags for flagged documents
   ├─ Transition status: STA-001 (NEW) → STA-002 (REVIEWED)
   └─ Log all corrections to tag_audit_log
   
5. Activate (Operations)
   └─ Transition status: STA-002 (REVIEWED) → STA-003 (ACTIVE)
   └─ Document now searchable/filterable by tag
```

---

## Multi-Faceted Tag Combinations

### Common Query Scenarios

**Scenario 1: Finance Department - Invoice Review**
```
Query: Find ACTIVE invoices with CRITICAL priority
Tags: domain_id = 'DOM-002' (Finance: Invoices)
      + category_id = 'CAT-008' (Metrics: KPI tracking)
      + priority_id = 'PRI-001' (Critical)
      + status_id = 'STA-003' (ACTIVE)

Result Set: ~15 documents
UI Filter: [Domain: Finance] [Category: Metrics] [Priority: Critical]
Action: Finance lead reviews for payment discrepancies
```

**Scenario 2: Compliance Audit - Legal Documents**
```
Query: Find all REVIEWED and ACTIVE legal documents
Tags: domain_id IN ('DOM-001', 'DOM-005', 'DOM-006') (Finance, Compliance, Risk)
      + status_id IN ('STA-002', 'STA-003') (REVIEWED or ACTIVE)

Result Set: ~300 documents
Export: Archive as audit evidence
Action: Auditor validates governance compliance
```

**Scenario 3: Product Launch - Specification Search**
```
Query: Find all ACTIVE specs in product domain from last 30 days
Tags: domain_id = 'DOM-007' (Product: Specifications)
      + category_id = 'CAT-007' (Data: Schema)
      + status_id = 'STA-003' (ACTIVE)
      + modified_at >= NOW() - INTERVAL '30 days'

Result Set: ~45 documents
UI Filter: [Domain: Product] [Category: Schema] [Time: Last 30d]
Action: Engineer references current spec version
```

**Scenario 4: Operational Risk - NEW Documents Pending Review**
```
Query: Find all NEW documents older than 48 hours (SLA breach)
Tags: status_id = 'STA-001' (NEW)
      + assigned_at <= NOW() - INTERVAL '48 hours'
      + domain_id = 'DOM-005' (Compliance)

Result Set: 2-3 documents
Alert: Send to domain lead (compliance@company.com)
Action: Triage + assign priority + reassign category if needed
```

---

## Priority & Status Finite State Machine

### State Transition Rules

**Valid Transitions (Status Lifecycle):**

```
NEW (STA-001)
├─ → REVIEWED (STA-002)  [Human accepts auto-assigned or corrects tags]
├─ → ARCHIVED (STA-005)  [Imported by mistake; delete without review]
└─ Terminal if no action taken for 60 days → Alert domain lead

REVIEWED (STA-002)
├─ → ACTIVE (STA-003)    [Domain lead approves for production use]
├─ → REJECTED (STA-006)  [Content invalid; mark for deletion]
└─ Terminal if stuck >7 days → Escalate to manager

ACTIVE (STA-003)
├─ → SUPERSEDED (STA-004) [Newer version available; keep for audit]
├─ → ARCHIVED (STA-005)   [End-of-life; retain in archive]
└─ Can remain indefinitely until domain lead marks obsolete

SUPERSEDED (STA-004)
└─ → ARCHIVED (STA-005)  [EOL; move to archive after retention period]

REJECTED (STA-006)
└─ → ARCHIVED (STA-005)  [Retention period → delete]

ARCHIVED (STA-005)
└─ TERMINAL (no transitions)
```

**Business Rules:**
- Only domain lead can transition status (enforce via role check in API)
- Transitions audit-logged with user, reason, timestamp
- Alerts if transition stalls >SLA threshold (48h NEW, 7d REVIEWED)
- Immutable once in ARCHIVED/REJECTED state

### Priority Escalation Rules

**Auto-Escalate to Management:**
- Any document in status NEW + priority PRI-001 (Critical) → auto-notify ASAP
- Any document in status REVIEWED + priority PRI-001 → force action within 24h
- If PRI-001 stuck in NEW >4h → escalate to CEO (for financial/compliance docs)

**Domain Lead Override:**
- Can promote/demote priority at any status
- Promotion (e.g., PRI-002 → PRI-001) triggers escalation notification
- Demotion (e.g., PRI-001 → PRI-002) requires manager approval
- All priority changes logged with reason

---

## Tag Dependency Matrix

### Which Tags Can Co-Exist?

**Allowed Combinations:**

| Domain | + Category | + Priority | Frequency | Notes |
|---|---|---|---|---|
| DOM-002 (Finance) | CAT-003 (Workflow) | PRI-001, PRI-002 | 40% | Urgent payment workflows |
| DOM-002 (Finance) | CAT-008 (Metrics) | PRI-001, PRI-002, PRI-003 | 35% | Revenue/expense KPIs |
| DOM-001 (Contracts) | CAT-005 (Policy) | PRI-001 | 15% | Legal governance |
| DOM-005 (Compliance) | CAT-005 (Policy) | PRI-001 | 8% | Regulatory requirements |
| DOM-007 (Product) | CAT-007 (Schema) | PRI-002, PRI-003 | 12% | Technical specs |

**Disallowed Combinations (Flag for review):**
- DOM-003 (Operations) + CAT-005 (Governance) → Usually wrong (should be DOM-005)
- DOM-007 (Product) + CAT-003 (Workflow) → Unclear (product spec or proc?)
- Any domain + status REJECTED + priority PRI-001 → Contradiction (reject critical doc?)

**Validation:** T02.5.2 API enforces allowed combinations via constraint table

---

## Integration Handoff Points

### T02.4.1 Classification → T02.5.1 Tags

**Data Flow:**
```
T02.4.1 Output:
{
  "document_id": "uuid-12345",
  "classification_type": "Invoice",
  "confidence": 0.943,
  "reasoning": "Contains 'Invoice #', 'Amount Due', payment terms"
}

↓ (T02.5.2 mapping logic)

T02.5.1 Input → document_tags row:
{
  "document_id": "uuid-12345",
  "domain_id": "DOM-002",     ← From mapping table
  "category_id": "CAT-008",   ← From mapping table
  "priority_id": null,         ← Default to PRI-004 later
  "status_id": "STA-001",     ← Always NEW on import
  "assigned_by": "system/classifier",
  "assigned_at": 2026-01-14T14:23:45Z
}
```

### T02.5.2 Tags → D02.1 Document Import Metadata

**Reverse Flow:**
```
When user imports document:
1. D02.1 creates documents row (document_id, import_date, dedup_hash)
2. D02.4 classifies document (confidence score)
3. T02.5.2 auto-assigns tags
4. D02.1 enriches documents.metadata with tag info:
   {
     "tag_domain": "DOM-002",
     "tag_category": "CAT-008",
     "tag_status": "STA-001",
     "classification_confidence": 0.943
   }

Result: Documents searchable by tag immediately after import
```

### T02.3 Metadata Store Index Integration

**Performance Indices:**

```sql
-- Enable tag-based queries on document_tags
CREATE INDEX idx_document_tags_domain_status 
  ON document_tags(domain_id, status_id, assigned_at DESC);

CREATE INDEX idx_document_tags_category_priority 
  ON document_tags(category_id, priority_id, modified_at DESC);

CREATE INDEX idx_document_tags_status_age
  ON document_tags(status_id, assigned_at DESC)
  WHERE status_id IN ('STA-001', 'STA-002');  -- Only for active workflow

-- Audit log indices for compliance queries
CREATE INDEX idx_tag_audit_document_date
  ON tag_audit_log(document_id, changed_at DESC);

CREATE INDEX idx_tag_audit_changed_by_date
  ON tag_audit_log(changed_by, changed_at DESC);
```

**Cardinality Estimates (150K documents):**
- Per domain: 15K-25K documents (fairly balanced)
- Per category: 10K-30K documents (some variance)
- Per status: NEW 5K, REVIEWED 80K, ACTIVE 60K, ARCHIVED 5K
- → All queries <100ms with indices

---

## Acceptance Criteria (T02.5.1 Design)

- [x] **AC-D01:** Tag schema has 4 independent dimensions (domain, category, priority, status)
- [x] **AC-D02:** Relationship mappings enable clear classification → tag handoff
- [x] **AC-D03:** State machine enforces valid status transitions (NEW → REVIEWED → ACTIVE)
- [x] **AC-D04:** Governance model clarifies ownership (domain lead, manager, architect)
- [x] **AC-D05:** Query patterns documented for common use cases (4 scenarios)
- [x] **AC-D06:** Integration points defined (T02.4.1, D02.3, D02.1)

**Status:** ✅ ALL ACs MET

---

## Appendix: Example Tag Assignments

### Example 1: Auto-Assigned Invoice

```
Input:
  Document: vendor_invoice_2026_001.pdf
  Classification: Invoice (confidence: 95%)
  
Auto-Assignment:
  domain_id: DOM-002 (Finance: Invoices)
  category_id: CAT-008 (Metrics: KPI tracking)
  priority_id: PRI-004 (Low, default)
  status_id: STA-001 (NEW)
  assigned_by: "system/t02.4.3"
  
Human Review:
  Domain lead: "This is URGENT - vendor payment overdue"
  Action: priority_id = PRI-001 (Critical)
  Action: status_id = STA-002 (REVIEWED)
  Audit Log: {field: priority_id, old: PRI-004, new: PRI-001, changed_by: finance.lead@co.com}
```

### Example 2: Manual-Assigned Specification

```
Input:
  Document: architecture_design_v4.docx
  Classification: Other (confidence: 68%) - Below threshold
  
Manual Assignment:
  Domain lead reviews: "This is our new microservices spec"
  domain_id: DOM-007 (Product: Specifications)
  category_id: CAT-007 (Data: Schema/Technical)
  priority_id: PRI-002 (High) - New product launch urgency
  status_id: STA-002 (REVIEWED) - Trusted source
  assigned_by: "product.lead@co.com"
```

### Example 3: Compliance Document (Multi-Domain)

```
Input:
  Document: gdpr_compliance_procedure.pdf
  Classification: Could be procedure or policy
  
Question: Should we assign multiple domains?
Answer: NO - One document gets exactly ONE domain_id + ONE category_id
        If document spans domains, split into separate logical docs
        
Selected Assignment:
  domain_id: DOM-005 (Legal: Compliance)
  category_id: CAT-005 (Governance: Policy)
  priority_id: PRI-001 (Critical - regulatory requirement)
  status_id: STA-002 (REVIEWED - legal team signed off)
  assigned_by: "legal.counsel@co.com"
```

