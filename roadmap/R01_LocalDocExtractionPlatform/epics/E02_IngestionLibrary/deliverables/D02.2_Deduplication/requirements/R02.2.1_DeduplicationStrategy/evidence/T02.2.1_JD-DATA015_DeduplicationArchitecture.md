# Deduplication Architecture: Design Document

**Task:** T02.2.1_JD-DATA015_DefineDeduplicationStrategy  
**Owner:** DATA-015 (Data Architect)  
**Date:** 2026-01-14  
**Status:** ✅ ARCHITECTURE COMPLETE

---

## Executive Summary

Deduplication architecture uses SHA-256 hashing for deterministic duplicate detection with zero false negatives. Duplicates are rejected at import time with full audit trail. Performance targets: hash computation < 50ms (at import), lookups < 10ms (at dedup check).

---

## Deduplication Strategy

### Definition: What is a Duplicate?

**Two documents are duplicates if and only if their content is byte-for-byte identical.**

Measured by: SHA-256 hash of full document content (PDF text + metadata, DOCX text + metadata)

**Why SHA-256?**
- Cryptographically strong (collision resistance > 2^128, practically impossible)
- Fast computation (~50ms for typical documents)
- Deterministic (same input = same hash always)
- Widely supported, no vendor lock-in
- Industry standard for document integrity

### What is NOT a Duplicate?

- Different format, same content (PDF vs DOCX) → NOT duplicate
- Same filename, different content → NOT duplicate
- Slightly modified version (1 character changed) → NOT duplicate
- Different page order → NOT duplicate (because byte-for-byte comparison fails)

### Implications

This definition is **strict but unambiguous**. Users cannot accidentally mark different versions as the same. Audit trail captures every detection.

---

## Detection Architecture

### Hash Computation (T02.1.2 Integration)

**When:** At document import time (per T02.1.2 design)

**Where:** PDF/DOCX Parser Module computes hash on extracted text + metadata

**Output:** SHA-256 hash string (64 hex characters)

**Storage:** Stored in hash_index table at import time

### Hash Lookup (T02.2.3 Integration)

**When:** After import, check hash_index before committing document

**How:** `SELECT first_document_id FROM hash_index WHERE sha256_hash = ?`

**Performance Target:** < 10ms (with UNIQUE index on hash_index.sha256_hash)

**Result:** Found or Not Found (binary, no false positives)

---

## Handling Strategy

### Scenario 1: Document Never Seen Before

```
Hash lookup → NOT FOUND
Action: Accept document, insert into documents table, insert hash into hash_index
Audit log: "import_document_success" {document_id, hash, timestamp}
User feedback: "Document imported successfully"
```

### Scenario 2: Exact Duplicate Found

```
Hash lookup → FOUND (pointing to first_document_id)
Action: REJECT document, do NOT insert into documents table
Audit log: "duplicate_rejected" {hash, original_document_id, timestamp, user}
User feedback: "Document already imported (see document #{original_id})"
```

### Scenario 3: Override Required (Future)

```
Note: Not in E02 scope. If user wants to override:
- Requires explicit administrator approval
- Creates second record with same hash + "override_approved" flag
- Audit trail captures override with reason
```

---

## Schema Integration (T02.3.1)

### hash_index Table

```sql
CREATE TABLE hash_index (
  id INTEGER PRIMARY KEY,
  sha256_hash TEXT UNIQUE NOT NULL,  -- 64-char hex string
  first_document_id INTEGER NOT NULL REFERENCES documents(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  -- Indices for fast lookup
  INDEX idx_hash_lookup ON sha256_hash
);
```

**Key constraints:**
- UNIQUE on sha256_hash (enforces 1:1 mapping)
- NOT NULL on first_document_id (always reference first import)
- Index on sha256_hash (enables < 10ms lookups)

### Audit Trail

```sql
CREATE TABLE audit_log (
  id INTEGER PRIMARY KEY,
  event_type TEXT NOT NULL,  -- "import_document_success", "duplicate_rejected"
  document_id INTEGER REFERENCES documents(id),
  hash TEXT,  -- For duplicate_rejected events
  original_document_id INTEGER REFERENCES documents(id),  -- For duplicate_rejected
  details_json TEXT,  -- Additional metadata
  timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_event_type ON event_type,
  INDEX idx_timestamp ON timestamp
);
```

---

## Performance Model

### Hash Computation

**Baseline: ~50ms per document (at import time)**

| Operation | Time |
|-----------|------|
| Read file | 5ms |
| Parse & extract text | 20ms |
| SHA-256 hash | 10ms |
| Serialize hash | 5ms |
| **Total** | **~40-50ms** |

### Hash Lookup

**Baseline: < 10ms per lookup**

| Operation | Time |
|-----------|------|
| Query hash_index (UNIQUE index) | < 5ms |
| Transfer result | < 2ms |
| **Total** | **< 10ms** |

**Assumptions:**
- SQLite on local SSD
- hash_index has < 10M rows
- UNIQUE index is fast (B-tree structure)

### Batch Performance

**100-doc batch:**
- Computation: 100 × 50ms = 5 seconds
- Lookups: 100 × 10ms = 1 second
- Database inserts: 100 × 50ms = 5 seconds
- **Total: ~11 seconds** (including orchestration overhead)

---

## Governance Framework

### Authority: Who Decides?

**System automatically rejects duplicates** – No human decision required

- Hash is deterministic
- Duplicate definition is unambiguous
- System applies consistently

### Escalation Path

**User sees duplicate rejection:**

```
System: "Document rejected: duplicate of Document #4521 (uploaded 2026-01-10)"
User options:
  1. Accept rejection (most common)
  2. Contact admin if they believe it's NOT a duplicate
     → Admin reviews documents
     → If different: override (future feature)
     → If same: explain to user
```

### Audit Transparency

**Every duplicate detection is logged:**
- What hash was detected?
- Which document it matched?
- When was it detected?
- Who uploaded it?
- Full audit trail accessible to admins

---

## Justification for This Approach

| Decision | Why |
|----------|-----|
| SHA-256 | Fast, deterministic, collision-resistant, widely trusted |
| Byte-for-byte comparison | Unambiguous, no false positives, matches user mental model |
| Reject duplicates | Prevents data anomalies, simple for users to understand |
| Immutable audit trail | Governance requirement, enables debugging, regulatory compliance |
| Performance targets | < 10ms matches user expectation of "instant" feedback |

---

**Document Status:** Architecture COMPLETE. Ready for T02.2.2 (Implementation Design).
