# T02.5.1: Tag Schema – Governance & Integration Guide
**Owner:** DATA-024 (Ontology and Taxonomy Designer)  
**Date:** 2026-01-14  
**Status:** ✅ COMPLETE  
**Evidence Artifact:** Governance Model & Integration Documentation

---

## Governance Framework

### Role-Based Access Control

**Who Can Do What:**

| Action | Domain Lead | QA/Product | Manager | Architect | API Role |
|--------|---|---|---|---|---|
| View tags (read) | ✅ | ✅ | ✅ | ✅ | viewer |
| Create domain | ❌ | ❌ | ⚠️ Approval | ✅ | admin |
| Rename domain | ❌ | ❌ | ⚠️ Approval | ✅ | admin |
| Delete domain | ❌ | ❌ | ❌ | ✅ | admin |
| Assign tags (NEW → STA-002) | ✅ | ⚠️ CAT only | ❌ | ❌ | editor |
| Change priority | ✅ | ❌ | ⚠️ Escalate | ❌ | editor |
| Mark ARCHIVED | ✅ | ❌ | ✅ | ❌ | editor |
| Modify audit log | ❌ | ❌ | ❌ | ❌ | (immutable) |

**Legend:** ✅ Full access | ⚠️ Conditional | ❌ No access | (immutable) = System-only

### Change Control Process

**Step 1: Propose Change**
- Domain lead/QA submits ticket: DECN-E02-TAGS-[NN]
- Include: What's changing, why, impact, migration plan
- Example: "Add DOM-009 (HR) domain for employee handbooks"

**Step 2: Review & Approval**
- Architect reviews impact (schema changes? migration effort?)
- Product Manager approves (affects user search/filter UX?)
- Compliance reviews (audit implications?)
- **SLA:** 3 business days

**Step 3: Deployment**
- Deploy schema change via T02.5.2 migration
- Run mapping logic for existing docs (e.g., auto-assign new domain)
- Monitor performance (query plans, audit log volume)
- **SLA:** 1 business day

**Step 4: Validation**
- Domain lead spot-checks 20 documents
- Run query performance tests
- Confirm audit logs recording correctly
- **SLA:** 2 hours post-deploy

**Step 5: Rollback (if needed)**
- If issues found: Revert schema, re-assign old domain values
- Update audit log with rollback reason
- Notify all domain leads
- **SLA:** 30 minutes (hot-fix priority)

### Versioning Strategy

```
Tag Schema Version: MAJOR.MINOR.PATCH

MAJOR = Breaking changes (incompatible with old API)
MINOR = Backwards-compatible additions (new domains/categories)
PATCH = Bug fixes (no data model changes)

Examples:
  1.0.0 = Initial release (T02.5.1 design + T02.5.2 deploy)
  1.1.0 = Add DOM-009 (HR) [backwards compatible]
  1.2.0 = Add STA-007 (PENDING_REVIEW) [new status]
  2.0.0 = Restructure priority scale (P0-P4 → Priority enum) [breaking]

Deployed with: documents.tag_schema_version
  Allows queries: "Find all documents tagged with v1.1.0 or later"
  Enables gradual rollout: Deploy v2.0 alongside v1.2, switch 10% → 50% → 100%
```

### Monitoring & Alerts

**Real-Time Alerts:**

| Alert | Threshold | Action |
|-------|-----------|--------|
| STA-001 (NEW) age > 48h | > 5 docs | Email domain lead |
| STA-002 (REVIEWED) age > 7d | > 3 docs | Escalate to manager |
| Tag assignment error rate | > 2% | Page on-call architect |
| Audit log lag | > 10s | Investigate database |
| Domain with 0 documents | Detected | Flag as unused; consolidate? |

**Weekly Metrics:**

```
Tag Usage Dashboard:
- Documents by domain (pie chart)
- Average time in each status (funnel)
- Priority distribution (stack bar)
- Top 10 domain+category combinations
- Audit log activity (who changed what)
```

---

## Integration Points

### D02.1 Document Importer Integration

**Workflow:**
```
User uploads: vendor_invoice_001.pdf
    ↓
D02.1 creates documents row: 
    {id: uuid-xxx, import_date: now, dedup_hash: abc123}
    ↓
D02.4 classifies: Invoice (confidence: 94%)
    ↓
T02.5.2 auto-assigns tag:
    {document_id: uuid-xxx, domain_id: DOM-002, category_id: CAT-008, status_id: STA-001}
    ↓
System notifies: finance.lead@co.com "1 new invoice waiting review"
    ↓
Finance lead reviews + marks: status_id: STA-002 (REVIEWED)
    ↓
Finance lead approves: status_id: STA-003 (ACTIVE)
    ↓
Document now searchable: GET /api/v1/documents?domain=DOM-002&status=STA-003
```

**Data Contract:**
```json
// D02.1 → T02.5.2 Input
{
  "document_id": "uuid-abc123",
  "import_date": "2026-01-14T10:00:00Z",
  "dedup_hash": "sha256:abc..."
}

// T02.5.2 → D02.1 Enrichment (metadata table)
{
  "document_id": "uuid-abc123",
  "tag_domain": "DOM-002",
  "tag_category": "CAT-008",
  "tag_status": "STA-001",
  "classification_confidence": 0.94
}
```

### D02.4 Classification Integration

**Confidence Thresholds:**

```
Classification Confidence → Tag Assignment Decision:

95-100%: ✅ Auto-assign (high confidence)
         └─ Assign domain_id + category_id immediately
         └─ Set status_id = STA-001 (NEW)
         
85-94%:  ⚠️  Auto-assign BUT flag for review
         └─ Assign domain_id + category_id
         └─ Set priority_id = PRI-002 (High) to surface for domain lead
         
70-84%:  ❓ Require human review
         └─ Create tag_review_queue entry
         └─ Notify domain lead: "3 documents need classification"
         
<70%:    ❌ Reject classification
         └─ Classify as "Other"
         └─ Defer to human (no auto-assignment)
```

**Feedback Loop:**
```
T02.4.3 generates 150 test documents:
  - 94.7% accuracy overall
  - Per-category: 88-97%
  
T02.5.2 reviews results:
  - Maps each classification to tag domain/category
  - Checks against domain lead feedback
  - Generates precision/recall per domain:
    * DOM-002 (Finance): 96% precision → confident classifier
    * DOM-005 (Compliance): 91% precision → may need manual review
    * DOM-007 (Product): 88% precision → review rate ↑
    
Output: Tagging accuracy correlates with classification confidence
        (validates T02.4.3 and informs future prompt tuning)
```

### D02.3 Metadata Store Integration

**Schema Dependencies:**

```sql
-- Foreign key ensures document_tags only references valid documents
ALTER TABLE document_tags
  ADD CONSTRAINT fk_document_tags_documents
  FOREIGN KEY (document_id)
  REFERENCES documents(id)
  ON DELETE CASCADE;

-- Ensures tag dimension tables are consistent with schema version
ALTER TABLE document_tags
  ADD CONSTRAINT chk_tag_schema_version
  CHECK (tag_schema_version = '1.0.0');

-- Performance: Indices on tag queries
CREATE INDEX idx_doc_tags_domain_status
  ON document_tags(domain_id, status_id, assigned_at DESC);

CREATE INDEX idx_doc_tags_category_priority
  ON document_tags(category_id, priority_id, modified_at DESC);
```

**Cardinality:**
- 150,000 documents (expected Year 1)
- 8 domains × 8 categories = 64 combinations (not all used)
- ~25K documents per domain on average
- Query latency: <100ms for faceted search (with indices)

---

## Migration Runbook (T02.3 → T02.5)

### Pre-Migration Checklist

- [ ] **Backup Database** (full snapshot before T02.5 deployment)
- [ ] **Freeze Documents** (no new imports during migration; duration ~2h)
- [ ] **Validate D02.3 Schema** (all documents have import_date, dedup_hash, id)
- [ ] **Validate D02.4 Classification** (150-doc test set has all classifications)
- [ ] **Communicate to Users** (email: "Platform maintenance 2-3pm today")

### Migration Steps

**1. Create Tag Schema (30 min)**
```bash
# Deploy: tag_domains, tag_categories, tag_priorities, tag_statuses tables
psql -U postgres < T02.5.1_tag_schema_ddl.sql

# Verify tables created
SELECT table_name FROM information_schema.tables 
  WHERE table_schema = 'public' AND table_name LIKE 'tag_%';
```

**2. Seed Reference Data (10 min)**
```bash
# Load tag dimension values (8 domains, 8 categories, 4 priorities, 6 statuses)
psql -U postgres < T02.5.1_tag_seed_data.sql

# Verify counts
SELECT COUNT(*) FROM tag_domains;    -- Should be 8
SELECT COUNT(*) FROM tag_categories; -- Should be 8
SELECT COUNT(*) FROM tag_priorities; -- Should be 4
SELECT COUNT(*) FROM tag_statuses;   -- Should be 6
```

**3. Create Indices (15 min)**
```bash
# Performance indices for tag queries
psql -U postgres < T02.5.1_tag_indices.sql

# Verify indices exist
SELECT indexname FROM pg_indexes WHERE tablename = 'document_tags';
```

**4. Run Auto-Assignment Batch (60 min)**
```bash
# For each document: map classification → domain/category, create tag row
python T02.5.2_batch_auto_assign_tags.py \
  --db-host localhost \
  --db-user postgres \
  --db-name doc_extractor \
  --batch-size 1000 \
  --log-file tag_migration_$(date +%Y%m%d_%H%M%S).log

# Expected output:
# Processed: 150,000 documents
# Auto-assigned: 142,500 (95%)
# Manual review queue: 7,500 (5%)
# Errors: 0
```

**5. Validate Data Integrity (15 min)**
```bash
# Check all documents have tags
SELECT COUNT(*) FROM documents d
  LEFT JOIN document_tags t ON d.id = t.document_id
  WHERE t.document_id IS NULL;
# Should return: 0

# Check status distribution
SELECT status_id, COUNT(*) FROM document_tags
  GROUP BY status_id;
# Should be: STA-001: 150k (all NEW initially)

# Check domain distribution (should be fairly balanced)
SELECT domain_id, COUNT(*) FROM document_tags
  GROUP BY domain_id ORDER BY domain_id;
```

**6. Create Audit Trail (5 min)**
```bash
# Log migration event for compliance
INSERT INTO tag_audit_log (document_id, field_changed, old_value, new_value, 
                           changed_by, changed_at, reason)
  SELECT id, 'tag_schema_version', NULL, '1.0.0', 'system/migration',
         NOW(), 'Initial tag schema deployment (T02.5.1 → T02.5.2)'
  FROM documents;

# Verify
SELECT COUNT(*) FROM tag_audit_log WHERE reason LIKE 'Initial tag%';
# Should equal 150,000
```

### Post-Migration Validation

**1. Query Performance (5 min)**
```bash
# Test queries from T02.5.1 design doc
EXPLAIN ANALYZE SELECT d.document_id, d.domain_id, d.category_id
  FROM document_tags d
  WHERE d.domain_id = 'DOM-002' AND d.priority_id = 'PRI-001'
  ORDER BY d.assigned_at DESC;
# Should show: index scan, <10ms execution time
```

**2. Application Smoke Tests (10 min)**
```bash
# Test API endpoints (from T02.5.2 implementation)
curl -X GET "http://api:8080/v1/documents?domain=DOM-002&status=STA-001"
curl -X PUT "http://api:8080/v1/documents/uuid-xxx/tags" \
  -H "Content-Type: application/json" \
  -d '{"status_id": "STA-002"}'

# Expected: 200 OK, valid response
```

**3. Domain Lead Spot Check (15 min)**
```bash
# Send 20 sample documents to domain leads for review
# Request: "Are these tags correct for your domain?"
# Response SLA: 1 hour
# Acceptance: >95% tagged correctly
```

**4. Alert Monitoring (ongoing)**
```bash
# Monitor for anomalies:
- Spike in tag_audit_log writes (unusual churn)
- Query latency >200ms (index issue)
- Failed API calls (connection error)
- NEW documents stuck >2 days (workflow blocked)
```

### Rollback Procedure (if issues found)

```bash
# 1. Stop all tag API services
systemctl stop tag-api

# 2. Restore database from pre-migration backup
pg_restore -d doc_extractor /backups/doc_extractor_pre_t025_2026-01-14.sql

# 3. Notify users
mail -s "Platform restored from backup" operations@co.com
<<< "Tag system rolled back. Migrations will retry tomorrow."

# 4. Post-mortem
# - Root cause analysis
# - Fix issue in T02.5.1/2 artifacts
# - Retry migration next day

# SLA: Complete rollback in <30 minutes
```

---

## Compliance & Audit Trail

### Immutable Audit Log

**Every tag change logged:**
```
INSERT INTO tag_audit_log (document_id, field_changed, old_value, new_value,
                           changed_by, changed_at, reason)
VALUES (uuid-xxx, 'status_id', 'STA-001', 'STA-002', 'finance.lead@co.com',
        NOW(), 'Document reviewed and approved');
```

**Audit Trail Queries:**
```sql
-- Show all tag changes for one document
SELECT * FROM tag_audit_log WHERE document_id = 'uuid-xxx'
  ORDER BY changed_at DESC;

-- Show who changed what tags in past 30 days
SELECT changed_by, COUNT(*) FROM tag_audit_log
  WHERE changed_at >= NOW() - INTERVAL '30 days'
  GROUP BY changed_by;

-- Show all REJECTED → ARCHIVED transitions (compliance evidence)
SELECT * FROM tag_audit_log
  WHERE field_changed = 'status_id' AND new_value = 'STA-005'
  ORDER BY changed_at DESC;
```

### Retention Policy

```
tag_audit_log retention:
  - Keep for 7 years (financial/legal regulatory requirement)
  - Archive to cold storage after 1 year
  - Never delete (immutable compliance record)
```

---

## Acceptance Criteria (Integration)

- [x] **AC-I01:** Governance model defines roles + change control process
- [x] **AC-I02:** Integration points documented for D02.1, D02.4, D02.3
- [x] **AC-I03:** Migration runbook provides step-by-step instructions (6 phases)
- [x] **AC-I04:** Audit trail captures all tag changes (immutable log)
- [x] **AC-I05:** Rollback procedure enables recovery <30 minutes if issues found

**Status:** ✅ ALL ACs MET

---

## Next: T02.5.2 Implementation

T02.5.2 (DEV-003) will deliver:
- ✅ Tag CRUD API endpoints (POST, PUT, DELETE, GET)
- ✅ Status machine enforcement (valid transitions enforced)
- ✅ Audit trail logging (automatic for all mutations)
- ✅ Integration tests with D02.3 foreign keys
- ✅ CLI tool for bulk operations (import/export tags)
- ✅ QC-101 sign-off (integration validated)

