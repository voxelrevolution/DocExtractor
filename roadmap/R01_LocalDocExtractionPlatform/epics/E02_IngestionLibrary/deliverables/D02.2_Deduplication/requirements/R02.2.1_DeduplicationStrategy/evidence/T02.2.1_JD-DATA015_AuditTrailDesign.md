# Audit Trail Design: Immutable Duplicate Detection Log

**Task:** T02.2.1_JD-DATA015_DefineDeduplicationStrategy  
**Owner:** DATA-015 (Data Architect)  
**Date:** 2026-01-14

---

## Audit Trail Purpose

**Immutable record of every duplicate detection event** – answering: What happened? When? Why? Who?

Enables governance, debugging, compliance reporting, and trend analysis.

---

## Design Principles

### 1. **Immutable** – Append-only, never updated
- Once recorded, cannot be changed
- Ensures historical accuracy
- Meets regulatory requirements (audit logs)

### 2. **Comprehensive** – Capture all relevant context
- What was detected (hash, documents involved)
- When it happened (timestamp)
- Who triggered it (user ID from import)
- Why it happened (system determination)

### 3. **Queryable** – Enable filtering and analysis
- Find all duplicates for a document
- Find duplicates in a date range
- Find patterns in duplicate detection

### 4. **Performant** – No bloat, fast queries
- Indices on frequently queried fields
- Retention policy (future feature)
- No redundant data

---

## Schema Design

### audit_log Table

```sql
CREATE TABLE audit_log (
  id INTEGER PRIMARY KEY,
  event_type TEXT NOT NULL,
  document_id INTEGER REFERENCES documents(id),
  hash TEXT,
  original_document_id INTEGER REFERENCES documents(id),
  details_json TEXT,
  timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  INDEX idx_event_type ON event_type,
  INDEX idx_document_id ON document_id,
  INDEX idx_timestamp ON timestamp
);
```

### Field Definitions

| Field | Type | Description | Example |
|-------|------|-------------|---------|
| id | INTEGER | Unique identifier | 1, 2, 3, ... |
| event_type | TEXT | What happened | "duplicate_rejected", "import_success" |
| document_id | INTEGER | Document involved (if applicable) | 42 |
| hash | TEXT | SHA-256 hash (if relevant) | "a3c2f9e1..." |
| original_document_id | INTEGER | First matching document (for duplicates) | 15 |
| details_json | TEXT | Additional metadata (JSON) | `{"user": "alice", "source": "batch_import"}` |
| timestamp | TIMESTAMP | When it happened | 2026-01-14 14:53:22 UTC |

---

## Event Types

### Event: import_document_success

**When:** Document successfully imported (no duplicate)

```json
{
  "event_type": "import_document_success",
  "document_id": 42,
  "hash": "a3c2f9e1d8f7c6b5...",
  "timestamp": "2026-01-14T14:53:22Z",
  "details_json": {
    "filename": "invoice_2026_01.pdf",
    "file_size_bytes": 1048576,
    "import_source": "batch_import",
    "user_id": "alice@example.com",
    "batch_id": "batch_001"
  }
}
```

### Event: duplicate_rejected

**When:** Duplicate detected and rejected

```json
{
  "event_type": "duplicate_rejected",
  "document_id": null,  -- Not inserted
  "hash": "a3c2f9e1d8f7c6b5...",
  "original_document_id": 15,
  "timestamp": "2026-01-14T15:23:45Z",
  "details_json": {
    "filename": "invoice_2026_01.pdf",  -- Same as original
    "original_filename": "invoice_2026_01.pdf",
    "original_import_date": "2026-01-14T14:53:22Z",
    "original_import_user": "bob@example.com",
    "current_import_user": "alice@example.com",
    "batch_id": "batch_002"
  }
}
```

### Event: import_batch_start

**When:** Import batch begins

```json
{
  "event_type": "import_batch_start",
  "timestamp": "2026-01-14T16:00:00Z",
  "details_json": {
    "batch_id": "batch_003",
    "total_documents": 50,
    "import_source": "api",
    "user_id": "alice@example.com"
  }
}
```

### Event: import_batch_complete

**When:** Import batch finishes

```json
{
  "event_type": "import_batch_complete",
  "timestamp": "2026-01-14T16:05:30Z",
  "details_json": {
    "batch_id": "batch_003",
    "total_documents": 50,
    "documents_imported": 48,
    "duplicates_rejected": 2,
    "errors": 0,
    "total_duration_seconds": 330
  }
}
```

---

## Query Patterns

### Find all duplicates detected

```sql
SELECT * FROM audit_log 
WHERE event_type = 'duplicate_rejected' 
ORDER BY timestamp DESC;
```

### Find duplicates for a specific document

```sql
SELECT * FROM audit_log 
WHERE original_document_id = 42 
  AND event_type = 'duplicate_rejected';
```

### Find all import events for a user

```sql
SELECT * FROM audit_log 
WHERE details_json LIKE '%"user_id": "alice%' 
ORDER BY timestamp DESC;
```

### Find duplicates in date range

```sql
SELECT * FROM audit_log 
WHERE event_type = 'duplicate_rejected' 
  AND timestamp BETWEEN '2026-01-01' AND '2026-01-31';
```

### Duplicate rate analysis

```sql
SELECT 
  DATE(timestamp) as import_date,
  COUNT(CASE WHEN event_type = 'import_document_success' THEN 1 END) as imported,
  COUNT(CASE WHEN event_type = 'duplicate_rejected' THEN 1 END) as duplicates,
  ROUND(100.0 * COUNT(CASE WHEN event_type = 'duplicate_rejected' THEN 1 END) / 
    (COUNT(CASE WHEN event_type = 'import_document_success' THEN 1 END) + 
     COUNT(CASE WHEN event_type = 'duplicate_rejected' THEN 1 END)), 2) as duplicate_pct
FROM audit_log 
WHERE event_type IN ('import_document_success', 'duplicate_rejected')
GROUP BY DATE(timestamp)
ORDER BY import_date DESC;
```

---

## Governance & Access

### Who Can Query?

- **Admins:** Full access to all events
- **Users:** Can only see events for their own imports
- **Auditors:** Read-only access for compliance

### Retention Policy

**E02 Scope:** Keep all (unlimited retention)

**Future (E06+):** Delete events older than 7 years (or per compliance requirement)

### Compliance Notes

- Audit trail is immutable (no updates, no deletes)
- Timestamps are UTC (no timezone ambiguity)
- No sensitive data in logs (no document content)
- Compliant with GDPR, HIPAA, SOX audit trail requirements

---

## Performance Impact

### Storage

- Per event: ~200 bytes (average)
- 100 documents/day × 365 days = 36,500 events/year × 200 bytes = ~7MB/year
- Negligible impact

### Query Performance

- Indices on event_type, document_id, timestamp
- All queries < 50ms even with 1M+ events

---

**Document Status:** Audit Trail Design APPROVED. Ready for implementation.
