# Task Specification: T02.3.1_JD-DEV003_DesignSQLSchema

**Assigned To:** DEV-003 (Database Developer)  
**Epic:** E02 – Ingestion Library  
**Deliverable:** D02.3 – Metadata Storage  
**Requirement:** R02.3.1 – Database Schema Design  
**Estimated Effort:** 8 hours  
**Status:** Ready for Execution  
**Created:** 2026-01-14

---

## SECTION 1: GOVERNANCE (EMBEDDED)

### File Specification

This task creates the following files in these exact locations with these exact names:

#### Primary Deliverable
- **File Name:** T02.3.1_JD-DEV003_DesignSQLSchema.md
- **Location:** `/roadmap/R01_LocalDocExtractionPlatform/epics/E02_IngestionLibrary/deliverables/D02.3_MetadataStore/requirements/R02.3.1_DatabaseSchema/tasks/`
- **Purpose:** Task specification (this document)
- **Owner:** DEV-003
- **Completion Signal:** File exists with full acceptance criteria documentation

#### Evidence Artifacts (Create as Work Progresses)

| Artifact | File Name | Location | Owner | Purpose |
|----------|-----------|----------|-------|---------|
| Schema ERD & Design | T02.3.1_JD-DEV003_SchemaDiagram.md | `/evidence/R02.3.1_DatabaseSchema/` | DEV-003 | Entity-relationship diagram, tables, relationships |
| Data Dictionary | T02.3.1_JD-DEV003_DataDictionary.md | `/evidence/R02.3.1_DatabaseSchema/` | DEV-003 | Column definitions, types, constraints, defaults |
| Normalization Analysis | T02.3.1_JD-DEV003_NormalizationAnalysis.md | `/evidence/R02.3.1_DatabaseSchema/` | DEV-003 | Normal forms applied, redundancy elimination, trade-offs |
| Indexing Strategy | T02.3.1_JD-DEV003_IndexingStrategy.md | `/evidence/R02.3.1_DatabaseSchema/` | DEV-003 | Primary/foreign keys, composite indexes, performance targets |
| DDL Statements | T02.3.1_JD-DEV003_DDLStatements.md | `/evidence/R02.3.1_DatabaseSchema/` | DEV-003 | CREATE TABLE scripts, constraints, triggers |
| QC-101 Sign-Off | T02.3.1_JD-QC101_SignOff.md | `/evidence/R02.3.1_DatabaseSchema/` | QC-101 | Schema validation sign-off |

**Pattern Enforced:** All artifacts follow `T02.3.1_JD-[ROLE]_[Type].md` naming; all live in `evidence/R02.3.1_DatabaseSchema/`

---

## SECTION 2: TASK DEFINITION

### Objective

**Design a robust PostgreSQL schema that stores document metadata, deduplication hashes, classification results, and tags. Schema must support efficient querying, enforce data integrity, and scale to 1M+ documents.**

### Context

From T02.1.1 (Import Scope):
- Documents: PDF, DOCX, images (up to 1000 per batch)
- Metadata: filename, size, hash, import timestamp, batch ID
- Audit trail: import source, user, timestamp, status
- Error handling: failed imports logged, retry-able

From T02.2.1 (Deduplication Architecture):
- Hash-based deduplication using SHA-256
- Immutable audit trail for deduplicate detection
- Zero false-negatives requirement
- Performance: < 10ms hash lookups

From D02.4 (Classification):
- Document classification into taxonomy (20-50 categories)
- Confidence scores per classification
- Classification audit trail

From D02.5 (Tagging):
- User-defined tags per document
- Tag grouping/organization
- Bulk tag operations

### Description

Design a SQL schema that integrates all these requirements:

1. **Core Tables** – Design normalized tables for:
   - **documents** – Core document records (id, filename, size, import_time, batch_id, hash)
   - **document_hashes** – SHA-256 hashes for deduplication (doc_id, hash, is_duplicate, first_seen)
   - **document_classifications** – Classification results (doc_id, category, confidence, model_version)
   - **document_tags** – User-defined tags (doc_id, tag_id, assigned_at, assigned_by)
   - **tags** – Tag definitions (id, name, description, created_by)
   - **import_batches** – Batch metadata (id, batch_time, source, user, doc_count)
   - **audit_log** – Immutable audit trail (id, entity_type, entity_id, action, timestamp, user, old_value, new_value)

2. **Relationships & Constraints** – Define:
   - Primary keys (UUID for documents, surrogate for audit log)
   - Foreign keys (documents → batches, classifications → documents, tags → documents)
   - Unique constraints (one hash per document, one classification per document per model)
   - NOT NULL constraints (required fields: filename, import_time, hash)
   - Check constraints (confidence in [0,1], is_duplicate boolean)

3. **Normalization** – Apply normalization for:
   - Eliminate redundancy (separate tables for batches, classifications, tags)
   - Support flexible tag assignment (many-to-many via document_tags bridge table)
   - Maintain audit trail integrity (immutable audit_log table, no updates to historical records)
   - Avoid unnecessary joins (denormalize sparingly: batch_id in documents table for query performance)

4. **Indexing Strategy** – Plan indexes for:
   - **Primary lookups:** hash_index on (hash) for < 10ms dedup checks
   - **Query optimization:** composite index (import_batch_id, is_duplicate) for batch-level dedup reporting
   - **Time-series queries:** index on import_time for archival and retention
   - **Classification queries:** index on (classification_category) for filtering by document type
   - **Tag queries:** index on document_tags(tag_id, doc_id) for bulk tag operations
   - **Audit queries:** index on audit_log(entity_type, entity_id, timestamp) for compliance audits

5. **Performance Targets** – Schema design must support:
   - Hash lookups: < 10ms (UNIQUE index on hash)
   - Batch imports: < 1.2 seconds per document (insert + index update)
   - Dedup reporting: < 500ms for batch-level stats (composite index + aggregation)
   - Classification updates: < 100ms per document (direct insert)
   - Tag operations: < 50ms per tag assignment (bridge table insert)
   - Audit queries: < 1s for compliance reports (indexed on entity_type, timestamp)

6. **Scalability Assumptions** – Schema must handle:
   - 1M+ documents in documents table
   - 100M+ rows in audit_log (10+ years of history)
   - Partition audit_log by year (reduce query time on recent entries)
   - Archive imported documents older than 7 years to separate partition

---

## SECTION 3: ACCEPTANCE CRITERIA (8 Gates)

### Gate 1: Schema Completeness
**Question:** Does the schema cover all data requirements from T02.1.1, T02.2.1, D02.4, D02.5?

**Acceptance:**
- [x] documents table (filename, size, hash, import_time, batch_id, status)
- [x] document_hashes table (SHA-256 hash, is_duplicate, first_seen)
- [x] document_classifications table (category, confidence, model_version)
- [x] document_tags table (tag_id, doc_id bridge)
- [x] tags table (tag name, description)
- [x] import_batches table (batch metadata)
- [x] audit_log table (immutable audit trail)
- [x] All tables have primary keys and meaningful relationships

**Sign-Off:** DEV-003 certifies all tables present and relationships correct.

### Gate 2: Normalization Soundness
**Question:** Is the schema properly normalized? Are redundancies minimized without hurting performance?

**Acceptance:**
- [x] No data redundancy (each fact stored once, accessed via joins or denormalization rationale)
- [x] Foreign key constraints defined for all relationships
- [x] Many-to-many relationships use bridge tables (e.g., document_tags)
- [x] Audit trail uses immutable append-only pattern (no updates to historical records)
- [x] Normalization trade-offs documented (e.g., "batch_id denormalized in documents for query speed")

**Sign-Off:** DEV-003 confirms schema follows 3NF with justified denormalizations.

### Gate 3: Constraint & Integrity Design
**Question:** Will constraints enforce data integrity?

**Acceptance:**
- [x] Primary keys enforce uniqueness (UUID on documents, bigint on audit_log)
- [x] Foreign keys prevent orphaned records (documents.batch_id → import_batches.id)
- [x] NOT NULL constraints on required fields (filename, import_time, hash)
- [x] UNIQUE constraint on hash for dedup correctness (no duplicate hashes)
- [x] Check constraints for valid ranges (confidence in [0,1], is_duplicate boolean)
- [x] Uniqueness constraint on (doc_id, classification_category, model_version) to prevent duplicate classifications

**Sign-Off:** QC-101 validates constraints prevent data corruption.

### Gate 4: Indexing Strategy Validation
**Question:** Will indexes meet performance targets without degrading writes?

**Acceptance:**
- [x] Hash lookups < 10ms: UNIQUE index on (hash)
- [x] Batch dedup reporting: composite index on (import_batch_id, is_duplicate)
- [x] Time-series: index on (import_time) for archival
- [x] Classification filters: index on (classification_category)
- [x] Tag operations: index on (tag_id, doc_id)
- [x] Audit queries: composite index on (entity_type, entity_id, timestamp)
- [x] Trade-offs documented (e.g., "No index on is_duplicate globally; use batch-level composite instead to minimize insert overhead")

**Sign-Off:** DEV-003 confirms indexes meet performance targets.

### Gate 5: Scalability Plan
**Question:** Will schema scale to 1M+ documents and 100M+ audit records?

**Acceptance:**
- [x] Partitioning strategy for large tables (audit_log by year; documents by import_year if >10M)
- [x] Archive plan for old data (documents > 7 years old → archive partition)
- [x] Vacuum/autovacuum strategy to maintain index efficiency
- [x] Storage estimates: documents table ~100GB for 1M docs (100KB metadata per doc avg)
- [x] Index sizes estimated (~5GB for composite indexes on 1M docs)

**Sign-Off:** DEV-003 confirms schema supports projected scale.

### Gate 6: DDL Correctness
**Question:** Are the CREATE TABLE statements syntactically correct and ready for deployment?

**Acceptance:**
- [x] CREATE TABLE statements use PostgreSQL syntax (SERIAL, UUID, TIMESTAMPTZ)
- [x] Data types chosen for correctness (TEXT for strings, BIGINT for large counts, UUID for IDs)
- [x] Constraints defined inline or as separate ALTER TABLE statements
- [x] Comments added to tables and columns (purpose, units, acceptable ranges)
- [x] No deprecated syntax; compatible with PostgreSQL 14+

**Sign-Off:** QC-101 validates DDL syntax and readiness for Alembic migration scripts.

### Gate 7: Integration with D02.1, D02.2, D02.4, D02.5
**Question:** Does schema integrate cleanly with import (D02.1), deduplication (D02.2), classification (D02.4), tagging (D02.5)?

**Acceptance:**
- [x] D02.1 Integration: documents table receives import_time, batch_id, import_source; audit_log tracks import events
- [x] D02.2 Integration: document_hashes table stores SHA-256 hash with is_duplicate flag; audit_log tracks dedup detections
- [x] D02.4 Integration: document_classifications table stores category and confidence; audit_log tracks classification changes
- [x] D02.5 Integration: document_tags + tags tables support user-defined tags; audit_log tracks tag assignments
- [x] No surprises for implementation (all queries and joins documented in NormalizationAnalysis artifact)

**Sign-Off:** All related teams (D02.1-D02.5 owners) confirm schema alignment.

### Gate 8: QC-101 Approval
**Question:** Does schema meet all DoD gates and pass final review?

**Acceptance:**
- [x] Schema is complete, normalized, and well-constrained
- [x] Indexes meet performance targets; scalability plan documented
- [x] DDL is correct and deployment-ready
- [x] Integration with D02.1, D02.2, D02.4, D02.5 validated
- [x] No blockers for T02.3.2 (Migrations) to proceed

**Sign-Off:** QC-101 certifies schema ready for implementation phase.

---

## SECTION 4: ASSIGNED JOB DESCRIPTION

**Role:** DEV-003 (Database Developer)

**World-Class Behaviors Applied to This Task:**

1. **Data Modeling & Normalization** – Apply domain analysis to identify entities (documents, batches, classifications, tags) and relationships; normalize to 3NF while assessing performance impacts; document decisions.

2. **Performance & Scalability** – Design indexes on frequently queried columns (hash, classification_category, import_time); partition large tables (audit_log by year); benchmark expected query times.

3. **Data Integrity & Security** – Define constraints (PRIMARY KEY, FOREIGN KEY, UNIQUE, NOT NULL, CHECK) to enforce valid data entry; plan backup strategy and audit trail.

4. **Collaboration & Communication** – Provide clear schema diagram (ERD) and data dictionary for developers integrating with the database; coordinate with D02.1, D02.2, D02.4, D02.5 teams.

5. **Continuous Improvement** – Document trade-offs (e.g., denormalization rationale); identify future improvements (e.g., partial indexes, materialized views for reporting).

---

## SECTION 5: EVIDENCE ARTIFACTS (Acceptance Checklist)

**This task is complete when all of the following artifacts exist:**

- [ ] **T02.3.1_JD-DEV003_SchemaDiagram.md** – ERD showing all tables, relationships, cardinalities, primary/foreign keys
- [ ] **T02.3.1_JD-DEV003_DataDictionary.md** – Column definitions, types, constraints, default values, acceptable ranges
- [ ] **T02.3.1_JD-DEV003_NormalizationAnalysis.md** – Normal forms analysis, redundancy elimination, denormalization justification
- [ ] **T02.3.1_JD-DEV003_IndexingStrategy.md** – Indexes planned, query performance targets, trade-offs (insert vs. query speed)
- [ ] **T02.3.1_JD-DEV003_DDLStatements.md** – CREATE TABLE scripts, constraints, comments, ready for migration scripts
- [ ] **T02.3.1_JD-QC101_SignOff.md** – QC-101 validation against all 8 gates; approval to proceed to T02.3.2

---

## SECTION 6: DEFINITION OF DONE

**Task is done when:**
1. ✅ All 6 evidence artifacts created and stored in `/evidence/R02.3.1_DatabaseSchema/`
2. ✅ Schema design passes all 8 acceptance gates (DEV-003 + QC-101 validation)
3. ✅ ERD and DDL are ready for T02.3.2 (Migration script generation)
4. ✅ No blockers for T02.3.3 (Performance tuning to follow schema)
5. ✅ Both dashboards updated to reflect T02.3.1 completion

---

## SECTION 7: KICKOFF CHECKLIST

- [x] Task spec created with embedded governance
- [x] Acceptance criteria clear (8 gates defined)
- [x] Evidence artifacts specified (6 artifacts with exact file names and locations)
- [x] DEV-003 JD context hydrated (world-class behaviors applied)
- [x] No blockers; ready to execute immediately

**Status:** ✅ READY FOR EXECUTION

**Next Action:** DEV-003 (Database Developer) begins schema design following the 6 evidence artifacts structure.

---

**Document Status:** T02.3.1 task specification ready for immediate execution.
