# Routing Logic: Integration with D02.5 & LLM Pipeline

**Task:** T02.4.1_JD-DATA024_DefineClassificationTaxonomy  
**Evidence Artifact:** Routing Logic for Faceted Search & Compliance  
**Created By:** DATA-024 (Ontology and Taxonomy Designer)  
**Date:** 2026-01-14

---

## Executive Summary

Classification → D02.5 tagging system. Classification acts as primary facet; routing engine uses category + confidence + domain to determine tag set and compliance actions. No hierarchical inference; explicit routing rules per category.

---

## Routing Architecture

```
┌─ Document (classified by T02.4.2 LLM) ────┐
│ Category: Invoice                         │
│ Confidence: 0.92                          │
│ Domain: Financial                         │
│ Model Version: v1.0                       │
└─────────────────────────────────────────┬─┘
                                           │
                    ┌──────────────────────┴──────────────────────┐
                    │  Routing Decision Tree                       │
                    └──────────────────────┬──────────────────────┘
                                           │
         ┌─────────────┬──────────────────┬──────────────────────┐
         │             │                  │                      │
    Confidence    Domain Lookup     Tag Assignment      Compliance Action
    Check         (Financial)        (Add to D02.5)     (Audit Trail)
         │             │                  │                      │
    0.92 >= 0.85    Domain: FIN      Tags:              Log:
    PASS            Owner: Finance    · Financial         · Category: Invoice
                                       · TransactionDoc   · Confidence: 0.92
    confidence_level: HIGH             · PaymentRequest   · Router Version: 1.0
                                        · SensitiveData   · Timestamp: 2026-01-14T10:23:45Z
                                        · FinancialYear    · User: system
                                            [active]
```

---

## D02.5 Tagging Integration

### Tag Assignment by Category

**Financial Domain Categories → Tags:**

| Category | Tags Assigned | Confidence Threshold | Compliance Level |
|----------|---------------|----------------------|------------------|
| Invoice | Financial, TransactionDoc, PaymentRequest, SensitiveData | 0.85 | High |
| Receipt | Financial, TransactionDoc, PaymentConfirmation, SensitiveData | 0.85 | High |
| PurchaseOrder | Financial, TransactionDoc, PaymentRequest, Commitment | 0.80 | High |
| Quote | Financial, Proposal, NoCommitment | 0.75 | Medium |
| Statement | Financial, Summary, SensitiveData | 0.85 | High |
| CreditMemo | Financial, TransactionDoc, Adjustment | 0.85 | High |
| DebitMemo | Financial, TransactionDoc, Adjustment | 0.85 | High |
| ExpenseReport | Financial, ReimbursementRequest, HR | 0.80 | Medium |
| TaxDocument | Financial, Regulatory, HighSensitivity | 0.90 | High |
| PaymentConfirmation | Financial, TransactionDoc, PaymentConfirmation | 0.85 | High |

**Legal Domain Categories → Tags:**

| Category | Tags Assigned | Confidence Threshold | Compliance Level |
|----------|---------------|----------------------|------------------|
| Contract | Legal, Binding, Signature, SensitiveData | 0.90 | High |
| StatementOfWork | Legal, Deliverables, Reference | 0.85 | High |
| Liability | Legal, Insurance, HighSensitivity | 0.90 | High |
| TermsConditions | Legal, Policy, Public | 0.80 | Medium |
| Compliance | Legal, Regulatory, Audit, HighSensitivity | 0.90 | High |
| IntellectualProperty | Legal, IP, HighSensitivity, Confidential | 0.90 | High |
| LegalNotice | Legal, Regulatory, Mandatory, HighSensitivity | 0.95 | High |
| RegulatoryDocument | Legal, Regulatory, HighSensitivity | 0.90 | High |

**HR Domain Categories → Tags:**

| Category | Tags Assigned | Confidence Threshold | Compliance Level |
|----------|---------------|----------------------|------------------|
| EmploymentContract | HR, Binding, Personnel, SensitiveData | 0.90 | High |
| Payroll | HR, Financial, SensitiveData, Confidential | 0.90 | High |
| PerformanceReview | HR, Personnel, Confidential | 0.90 | High |
| Benefits | HR, ReimbursementRequest, SensitiveData | 0.85 | High |
| Training | HR, Development, Reference | 0.80 | Medium |
| Termination | HR, Personnel, HighSensitivity, Audit | 0.95 | High |

**Operations Domain Categories → Tags:**

| Category | Tags Assigned | Confidence Threshold | Compliance Level |
|----------|---------------|----------------------|------------------|
| ProjectPlan | Operations, Planning, Reference | 0.80 | Low |
| MeetingMinutes | Operations, Decision, Reference | 0.75 | Low |
| OrgChart | Operations, Reference, Public | 0.85 | Low |
| Policy | Operations, Governance, Reference | 0.85 | Medium |
| VendorDocument | Operations, Commitment, Reference | 0.80 | Medium |

**Other Domain Categories → Tags:**

| Category | Tags Assigned | Confidence Threshold | Compliance Level |
|----------|---------------|----------------------|------------------|
| Marketing | Operations, Public | 0.70 | Low |
| Correspondence | General, Reference | 0.70 | Low |
| Unclassifiable | General, RequiresReview | 0.00 | Medium (requires human review) |

---

## Routing Decision Tree

### Step 1: Validate Classification Confidence

```
IF classification.confidence >= category.confidence_threshold:
  PROCEED to Step 2 (Tag Assignment)
ELSE IF classification.confidence >= 0.70:
  TAG: RequiresReview
  LOG: "Low confidence; escalated for manual review"
  PROCEED to Step 2 with "Unclassifiable" category
ELSE:
  CLASSIFY as: Unclassifiable
  TAG: RequiresReview + ManualReview
  STOP (don't route further)
```

**Example:**
```
Document: Scanned receipt, low OCR quality
Classification: Receipt @ 0.62 confidence (< 0.85 threshold)
  → Tag: RequiresReview
  → Route to: Human reviewers queue
  → Audit log: "Receipt classification failed OCR quality check"
```

### Step 2: Assign Tags from Lookup Table

```
FOR category in document_classifications:
  IF classification.confidence >= category.confidence_threshold:
    ADD all tags in category.tags_assigned
    SET compliance_level = category.compliance_level
  ELSE:
    ADD tag: "RequiresReview"
    SET compliance_level = "High" (conservative)
```

**Example:**
```
Document: Invoice @ 0.92 confidence
  → Lookup: Invoice row in tag table
  → Tags: Financial, TransactionDoc, PaymentRequest, SensitiveData
  → Compliance Level: High
  → Store in document_tags table
```

### Step 3: Apply Compliance Actions

```
IF compliance_level == "High":
  ENCRYPT: document content (at rest)
  RESTRICT: access to Finance team only
  LOG: all read operations
  RETENTION: 7 years (SOX compliance)

IF compliance_level == "Medium":
  ENCRYPT: document content (at rest)
  RESTRICT: access to business owner
  LOG: all read operations (weekly summary)
  RETENTION: 3 years

IF compliance_level == "Low":
  ENCRYPT: optional
  RESTRICT: access to business owner
  LOG: no logging
  RETENTION: 1 year
```

**Example:**
```
Document: Invoice (High compliance)
  → Encrypt: AES-256
  → Access: Finance team (AD group) + doc owner
  → Logging: All reads → audit_log table
  → Retention: 2029-01-14 (7 years from import)
```

### Step 4: Route to D02.5 Tagging System

```
INSERT INTO document_tags (doc_id, tag, confidence, category, model_version)
VALUES 
  (123, 'Financial', 0.92, 'Invoice', 'v1.0'),
  (123, 'TransactionDoc', 0.92, 'Invoice', 'v1.0'),
  (123, 'PaymentRequest', 0.92, 'Invoice', 'v1.0'),
  (123, 'SensitiveData', 0.92, 'Invoice', 'v1.0');

-- Faceted filtering in D02.5
SELECT * FROM documents d
WHERE d.id IN (
  SELECT doc_id FROM document_tags 
  WHERE tag = 'Financial' 
    AND model_version = 'v1.0'
)
ORDER BY d.import_time DESC;
```

---

## Faceted Search Queries (D02.5 Implementation)

### Use Case 1: Finance Team Dashboard
```
SELECT d.filename, d.hash, dc.category, dt.tag, dc.confidence
FROM documents d
JOIN document_classifications dc ON d.id = dc.doc_id
JOIN document_tags dt ON d.id = dt.doc_id
WHERE dt.tag IN ('Financial', 'TransactionDoc')
  AND dc.confidence >= 0.85
  AND d.import_time >= CURRENT_DATE - INTERVAL '30 days'
ORDER BY d.import_time DESC
LIMIT 100;
```

**Result:** Finance dashboard shows last 30 days of verified financial documents.

### Use Case 2: Compliance Officer (High-Sensitivity Docs)
```
SELECT d.filename, dc.category, dc.confidence, COUNT(dt.tag) as tag_count
FROM documents d
JOIN document_classifications dc ON d.id = dc.doc_id
LEFT JOIN document_tags dt ON d.id = dt.doc_id AND dt.tag = 'HighSensitivity'
WHERE dt.tag IS NOT NULL
  OR dc.category IN ('TaxDocument', 'Termination', 'IntellectualProperty')
ORDER BY d.import_time DESC
LIMIT 500;
```

**Result:** Compliance sees all high-sensitivity documents for quarterly audit.

### Use Case 3: Unclassifiable Documents Queue
```
SELECT d.filename, dc.category, dc.confidence, d.import_time
FROM documents d
JOIN document_classifications dc ON d.id = dc.doc_id
WHERE (dc.category = 'Unclassifiable' OR dc.confidence < 0.70)
  AND d.status != 'MANUAL_CLASSIFIED'
ORDER BY d.import_time ASC
LIMIT 50;
```

**Result:** Manual reviewers see queue of 50 documents needing human classification.

---

## Routing Performance SLA

| Operation | Target | Rationale |
|-----------|--------|-----------|
| Classification lookup | <5ms | Redis cache (category → tags) |
| Tag insertion (batch) | <100ms for 1,000 docs | Bulk INSERT with batch_size=100 |
| Faceted query (single tag) | <200ms | Index on (tag, doc_id) |
| Faceted query (5 tags AND) | <500ms | Query optimization required |
| Compliance action (encrypt) | <1s per doc | Background job (async) |

**Scaling:** At 1M documents:
- Classification lookup: 5ms (cache hit rate 99%)
- Tag insertion: 10-15 minutes total (batch)
- Faceted queries: <500ms (indexed)
- Compliance actions: 24 hours (background jobs)

---

## Error Handling in Routing

### Scenario 1: Classification Service Timeout
```
IF classification.status == TIMEOUT (> 5 seconds):
  CLASSIFY as: Unclassifiable
  TAG: ProcessingError + RequiresReview
  LOG: "Classification timeout; manual review required"
  RETRY: Schedule for re-classification in 1 hour (max 3 retries)
```

### Scenario 2: Tag Lookup Fails
```
IF tag_lookup.status == ERROR:
  CLASSIFY as: Unclassifiable
  TAG: ProcessingError
  ALERT: Engineering team (PagerDuty)
  LOG: "Tag lookup failed; [error details]"
  STOP: Don't tag document (manual review required)
```

### Scenario 3: Compliance Action Fails
```
IF compliance_action.status == FAILED (e.g., encryption error):
  TAG: ComplianceError + HighSensitivity (override)
  LOG: "Encryption failed; document held until resolved"
  ALERT: Security team (PagerDuty)
  RESTRICT: No user access until resolved
```

---

## Version Management (Future)

**Current:** v1.0 (32 categories, flat taxonomy)

**Future (v1.1):** Add secondary facets (Business Function, Compliance Level)

**Future (v2.0):** Hierarchize taxonomy if classification accuracy improves

**Backward Compatibility:**
```
-- Keep classification with model_version
SELECT * FROM document_classifications
WHERE model_version = 'v1.0';

-- When v2.0 released, can run parallel classification
SELECT * FROM document_classifications
WHERE model_version IN ('v1.0', 'v2.0');

-- Migrate tags to v2.0 only after validation
UPDATE document_tags 
SET model_version = 'v2.0'
WHERE category IN (NEW_V20_CATEGORIES)
  AND confidence >= 0.90; -- Only migrate high-confidence docs
```

---

**Document Status:** Routing logic defined; ready for governance and compliance model design.
